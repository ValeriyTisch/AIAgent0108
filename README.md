# üß† PDF Entity Extraction Agent with LLM, RAG and Evaluation

–≠—Ç–æ—Ç –ø—Ä–æ–µ–∫—Ç —Ä–µ–∞–ª–∏–∑—É–µ—Ç pipeline –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —Å—É—â–Ω–æ—Å—Ç–µ–π –∏–∑ PDF-–¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º:

- üìÑ LangChain + OpenAI LLM
- üîç RAG —Å PGVector (PostgreSQL + –≤–µ–∫—Ç–æ—Ä–Ω—ã–µ embeddings)
- ‚úÖ –°—Ç—Ä–æ–≥–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ Pydantic
- üîÅ –ü–æ–≤—Ç–æ—Ä—ã (`retry`) –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫
- üìä –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Ü–µ–Ω–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ (precision, recall, f1)
- üñºÔ∏è –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Arize Phoenix –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
- üåê FastAPI API-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –ø–æ–¥–∞—á–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤

---

## üöÄ –ë—ã—Å—Ç—Ä—ã–π –∑–∞–ø—É—Å–∫ (—Å Docker Compose)

1. –ö–ª–æ–Ω–∏—Ä—É–π –ø—Ä–æ–µ–∫—Ç –∏ –ø–µ—Ä–µ–π–¥–∏ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é:

```bash
git clone https://github.com/your/repo.git
cd your-repo
```

2. –°–æ–∑–¥–∞–π `.env` –Ω–∞ –æ—Å–Ω–æ–≤–µ `.env.example`:

```bash
cp .env.example .env
```

3. –ó–∞–ø—É—Å—Ç–∏ –ø—Ä–æ–µ–∫—Ç:

```bash
docker-compose up --build
```

---

## üì§ API-–¥–æ—Å—Ç—É–ø (FastAPI)

–ü–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω OpenAPI Swagger UI –ø–æ –∞–¥—Ä–µ—Å—É:

üìç [http://localhost:8000/docs](http://localhost:8000/docs)

### –ü—Ä–∏–º–µ—Ä—ã —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤:

#### `POST /upload-pdf`
–ó–∞–≥—Ä—É–∑–∏—Ç—å PDF-—Ñ–∞–π–ª –Ω–∞ —Å–µ—Ä–≤–µ—Ä –∏ –ø–æ–ª—É—á–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç:

```bash
curl -X POST http://localhost:8000/upload-pdf \
  -H "accept: application/json" \
  -H "Content-Type: multipart/form-data" \
  -F "file=@pdfs/contract1.pdf"
```

#### `POST /analyze-text`
–û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–∂–µ –∏–∑–≤–ª–µ—á—ë–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –∏ –ø–æ–ª—É—á–∏—Ç—å JSON-–æ—Ç–≤–µ—Ç:

```bash
curl -X POST http://localhost:8000/analyze-text \
  -H "Content-Type: application/json" \
  -d '{"text": "–í–∞—à —Ç–µ–∫—Å—Ç –∏–∑ PDF –∑–¥–µ—Å—å..."}'
```

#### üì¶ –ü—Ä–∏–º–µ—Ä—ã –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ Python (—á–µ—Ä–µ–∑ `requests`)

```python
import requests

# –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ–∫—Å—Ç–∞
text_payload = {"text": "–í–∞—à —Ç–µ–∫—Å—Ç –∏–∑ PDF –∑–¥–µ—Å—å..."}
response = requests.post("http://localhost:8000/analyze-text", json=text_payload)
print(response.json())

# –ó–∞–≥—Ä—É–∑–∫–∞ PDF-—Ñ–∞–π–ª–∞
with open("pdfs/contract1.pdf", "rb") as f:
    files = {"file": ("contract1.pdf", f, "application/pdf")}
    response = requests.post("http://localhost:8000/upload-pdf", files=files)
    print(response.json())
```

---

## üì¶ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```bash
src/
‚îú‚îÄ‚îÄ api.py                    # FastAPI endpoints
‚îú‚îÄ‚îÄ pdf_llm_agent_pipeline.py # –û—Å–Ω–æ–≤–Ω–æ–π –∞–≥–µ–Ω—Ç
‚îú‚îÄ‚îÄ retriever_pgvector.py     # –í–µ–∫—Ç–æ—Ä–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ (PGVector)
‚îú‚îÄ‚îÄ llm_setup.py              # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ LLM
‚îú‚îÄ‚îÄ models.py                 # Pydantic –º–æ–¥–µ–ª–∏
‚îú‚îÄ‚îÄ text_extraction.py        # –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –∏–∑ PDF
‚îú‚îÄ‚îÄ phoenix_setup.py          # –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Arize Phoenix
‚îú‚îÄ‚îÄ eval_utils.py             # –ú–µ—Ç—Ä–∏–∫–∏ –∏ —ç–∫—Å–ø–æ—Ä—Ç –≤ Excel
run_batch_evaluation.py       # –û—Ü–µ–Ω–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ –ø–æ Excel
Dockerfile
requirements.txt
docker-compose.yml
.env
```

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ—Ü–µ–Ω–∫–∞

### üìÑ –®–∞–≥ 1: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ Excel —Å ground truth

–°–æ–∑–¥–∞–π —Ñ–∞–π–ª `data/test_ground_truth.xlsx` —Å–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π:

| filename      | inn         | date       | has_stamp | is_offer | mentions_guarantee |
|---------------|-------------|------------|-----------|----------|--------------------|
| contract1.pdf | 7707083893  | 2023-09-15 | TRUE      | FALSE    | TRUE               |
| contract2.pdf | 1234567890  | 2022-11-01 | FALSE     | TRUE     | FALSE              |

> ‚ö†Ô∏è PDF-—Ñ–∞–π–ª—ã –¥–æ–ª–∂–Ω—ã –ª–µ–∂–∞—Ç—å –≤ –ø–∞–ø–∫–µ `pdfs/`


### üß† –®–∞–≥ 2: –ó–∞–ø—É—Å–∫ –æ—Ü–µ–Ω–∫–∏

```bash
python run_batch_evaluation.py
```

–ë—É–¥–µ—Ç —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω —Ñ–∞–π–ª: `results/predictions_with_metrics.xlsx`

### üìä –ú–µ—Ç—Ä–∏–∫–∏:
- Precision
- Recall
- F1-score
- Accuracy

–¢–∞–∫–∂–µ –≤—ã–≤–æ–¥–∏—Ç—Å—è —Å–≤–æ–¥–∫–∞ –ø–æ –≤—Å–µ–º –¥–æ–∫—É–º–µ–Ω—Ç–∞–º –≤ –∫–æ–Ω—Å–æ–ª–∏.

---

## üìå –ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏
- OpenAI GPT-4 (–∏–ª–∏ o4-mini)
- LangChain (RAG)
- PGVector + SQLAlchemy
- Pydantic
- FastAPI
- Arize Phoenix
- Docker / docker-compose

---

## ‚úÖ TODO / –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è
- üîç –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –æ—à–∏–±–æ–∫ –≤ UI
- üìÅ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ zip-–∞—Ä—Ö–∏–≤–æ–≤ —Å PDF
- üìâ –û–±—É—á–µ–Ω–∏–µ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–π embedding-–º–æ–¥–µ–ª–∏
- üß™ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å CI –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Ä–µ–≥—Ä–µ—Å—Å–∏–∏

---

–ï—Å–ª–∏ —É —Ç–µ–±—è –æ—Å—Ç–∞–ª–∏—Å—å –≤–æ–ø—Ä–æ—Å—ã ‚Äî –æ—Ç–∫—Ä—ã–≤–∞–π Issue –∏–ª–∏ –ø–∏—à–∏ –≤ —á–∞—Ç!


–ï—Å–ª–∏ —É —Ç–µ–±—è –æ—Å—Ç–∞–ª–∏—Å—å –≤–æ–ø—Ä–æ—Å—ã ‚Äî –æ—Ç–∫—Ä—ã–≤–∞–π Issue –∏–ª–∏ –ø–∏—à–∏ –≤ —á–∞—Ç!


"""
L–≤–∞ —ç–Ω–¥–ø–æ–π–Ω—Ç–∞:

POST /upload-pdf ‚Äî –∑–∞–≥—Ä—É–∑–∫–∞ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ PDF

POST /upload-text ‚Äî –æ–±—Ä–∞–±–æ—Ç–∫–∞ —É–∂–µ –≥–æ—Ç–æ–≤–æ–≥–æ —Ç–µ–∫—Å—Ç–∞

‚úÖ run_agent_on_text() –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –æ–±–æ–∏—Ö —Å–ª—É—á–∞—è—Ö
‚úÖ –ü–∞—Ä—Å–∏–Ω–≥ ground_truth –∏–∑ —Å—Ç—Ä–æ–∫–∏
‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∑–∞–ø—É—Å–∫–∞ —á–µ—Ä–µ–∑ run_api.py

"""

docker-compose up --build
–ü–æ–¥–Ω–∏–º–∞–µ—Ç—Å—è FastAPI API + Postgres —Å pgvector + –≤—Å—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞.

–ò –º–æ–∂–Ω–æ —Å—Ä–∞–∑—É —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å LLM-–∞–≥–µ–Ω—Ç–∞ –ø–æ http://localhost:8000/docs



–ê–≥–µ–Ω—Ç –∏–∑–≤–ª–µ–∫–∞–µ—Ç —Å—É—â–Ω–æ—Å—Ç–∏, –∏ –¥–ª—è –∫–∞–∂–¥–æ–π –º—ã –ø—Ä–æ–≤–µ—Ä—è–µ–º True (–Ω–∞—à—ë–ª) –∏–ª–∏ False (–Ω–µ –Ω–∞—à—ë–ª):

–¢–µ—Ä–º–∏–Ω	–ß—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç
True Positive (TP)	–ê–≥–µ–Ω—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–∏–ª, —á—Ç–æ —Å—É—â–Ω–æ—Å—Ç—å –µ—Å—Ç—å (True)
False Positive (FP)	–ê–≥–µ–Ω—Ç —Å–∫–∞–∑–∞–ª, —á—Ç–æ —Å—É—â–Ω–æ—Å—Ç—å –µ—Å—Ç—å, –Ω–æ –µ—ë –Ω–µ—Ç
False Negative (FN)	–ê–≥–µ–Ω—Ç –ø—Ä–æ–ø—É—Å—Ç–∏–ª —Å—É—â–Ω–æ—Å—Ç—å, —Ö–æ—Ç—è –æ–Ω–∞ –±—ã–ª–∞

üìä –ú–µ—Ç—Ä–∏–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —Å—É—â–Ω–æ—Å—Ç–µ–π
–î–ª—è –æ—Ü–µ–Ω–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —Å—É—â–Ω–æ—Å—Ç–µ–π –∞–≥–µ–Ω—Ç–æ–º –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏:

üîπ Precision (—Ç–æ—á–Ω–æ—Å—Ç—å)
–ò–∑ –≤—Å–µ—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –∞–≥–µ–Ω—Ç –æ—Ç–º–µ—Ç–∏–ª –∫–∞–∫ –Ω–∞–π–¥–µ–Ω–Ω—ã–µ ‚Äî —Å–∫–æ–ª—å–∫–æ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –±—ã–ª–∏ –≤–µ—Ä–Ω—ã–º–∏?

Precision
=
ùëá
ùëÉ
ùëá
ùëÉ
+
ùêπ
ùëÉ
Precision= 
TP+FP
TP
‚Äã
 
TP (True Positive) ‚Äî –∞–≥–µ–Ω—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–ª –Ω–∞–ª–∏—á–∏–µ —Å—É—â–Ω–æ—Å—Ç–∏

FP (False Positive) ‚Äî –∞–≥–µ–Ω—Ç –æ—à–∏–±–æ—á–Ω–æ —É–∫–∞–∑–∞–ª, —á—Ç–æ —Å—É—â–Ω–æ—Å—Ç—å –µ—Å—Ç—å, –Ω–æ –µ—ë –Ω–µ—Ç

üîπ Recall (–ø–æ–ª–Ω–æ—Ç–∞)
–ò–∑ –≤—Å–µ—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –Ω–∞–π–¥–µ–Ω—ã ‚Äî —Å–∫–æ–ª—å–∫–æ –∞–≥–µ–Ω—Ç –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –Ω–∞—à—ë–ª?

Recall
=
ùëá
ùëÉ
ùëá
ùëÉ
+
ùêπ
ùëÅ
Recall= 
TP+FN
TP
‚Äã
 
FN (False Negative) ‚Äî –∞–≥–µ–Ω—Ç –ø—Ä–æ–ø—É—Å—Ç–∏–ª —Å—É—â–Ω–æ—Å—Ç—å, —Ö–æ—Ç—è –æ–Ω–∞ –±—ã–ª–∞ –≤ —Ç–µ–∫—Å—Ç–µ

üîπ F1-score
–°–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –º–µ—Ç—Ä–∏–∫–∞ –º–µ–∂–¥—É precision –∏ recall

F1
=
2
√ó
Precision
√ó
Recall
Precision
+
Recall
F1=2√ó 
Precision+Recall
Precision√óRecall
‚Äã
 
üìã –ü—Ä–∏–º–µ—Ä
–ü—Ä–µ–¥–ø–æ–ª–æ–∂–∏–º, –¥–ª—è –æ–¥–Ω–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞:

–°—É—â–Ω–æ—Å—Ç—å	–û–∂–∏–¥–∞–Ω–∏–µ (Ground Truth)	–ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ (Prediction)	–°–æ–≤–ø–∞–¥–µ–Ω–∏–µ
has_stamp	True	True	‚úÖ TP
is_offer	False	True	‚ùå FP
mentions_guarantee	True	False	‚ùå FN
inn	1234567890	1234567890	‚úÖ TP
date	2023-01-01	2022-01-01	‚ùå FN

TP = 2

FP = 1

FN = 2

–ú–µ—Ç—Ä–∏–∫–∏:

Precision = 2 / (2 + 1) = 0.666

Recall = 2 / (2 + 2) = 0.5

F1 = 2 * (0.666 * 0.5) / (0.666 + 0.5) ‚âà 0.571

–≠—Ç–∏ –º–µ—Ç—Ä–∏–∫–∏ –æ—Å–æ–±–µ–Ω–Ω–æ –ø–æ–ª–µ–∑–Ω—ã –ø—Ä–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –Ω–∞ –º–Ω–æ–∂–µ—Å—Ç–≤–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ (batch evaluation) —Å Excel-—Ñ–∞–π–ª–æ–º ground truth.